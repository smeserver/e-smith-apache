Index: e-smith-apache/e-smith-apache.spec
diff -u e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/00usedb:1.1.1.1 e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/00usedb:removed
--- e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/00usedb:1.1.1.1	Tue Jan  7 10:00:49 2003
+++ e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/00usedb	Wed Dec 31 19:00:00 1969
@@ -1,3 +0,0 @@
-{
-    use esmith::db;
-}
Index: e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/01localAccessString
diff -u e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/01localAccessString:1.2 e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/01localAccessString:1.3
--- e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/01localAccessString:1.2	Wed Jul  9 11:35:58 2003
+++ e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/01localAccessString	Mon Jul 18 14:52:00 2005
@@ -2,17 +2,12 @@
     #------------------------------------------------------------
     # Compute "localAccess" string for use in template below.
     #------------------------------------------------------------
-    my %networks;
-    tie %networks, 'esmith::config', '/home/e-smith/networks';
+    use esmith::NetworksDB;
 
-    use esmith::util;	    
-    
-    my @access = esmith::util::computeLocalAccessSpec( $LocalIP, 
-			$LocalNetmask, \%networks, 'private');
+    my $ndb = esmith::NetworksDB->open_ro();
 
-    $localAccess = "@access";
+    $localAccess = $ndb->local_access_spec();
     $localAccess =~ s#/255\.255\.255\.255##g;
 
     "";
 }
-
Index: e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/05NoHostLookups
diff -u e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/05NoHostLookups:1.1.1.1 e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/05NoHostLookups:1.2
--- e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/05NoHostLookups:1.1.1.1	Tue Jan  7 10:00:49 2003
+++ e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/05NoHostLookups	Mon Jul 18 14:52:00 2005
@@ -3,5 +3,5 @@
 # The default is off because it'd be overall better for the net if people
 # had to knowingly turn this feature on.
 
-HostnameLookups off
+HostnameLookups { $httpd{HostnameLookups} || 'off'; }
 
Index: e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/05ServerTokens
diff -u e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/05ServerTokens:1.1.1.1 e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/05ServerTokens:1.2
--- e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/05ServerTokens:1.1.1.1	Tue Jan  7 10:00:49 2003
+++ e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/05ServerTokens	Mon Jul 18 14:52:00 2005
@@ -1,5 +1,2 @@
-{
-    my $servertokens = db_get_prop($confref, 'httpd', 'ServerTokens') ||
-    			'ProductOnly';
-    $OUT = "ServerTokens $servertokens";
-}
+ServerTokens { $httpd{ServerTokens} || 'ProductOnly'; }
+
Index: e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/20LoadModule80mod_perl
diff -u e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/20LoadModule80mod_perl:1.4 e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/20LoadModule80mod_perl:1.5
--- e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/20LoadModule80mod_perl:1.4	Tue Nov  9 15:36:38 2004
+++ e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/20LoadModule80mod_perl	Mon Jul 18 14:52:00 2005
@@ -1,6 +1,6 @@
 {
     # vim: ft=perl:
-    my $status = $modPerl{status} || '';
+    my $status = $modPerl{status} || 'enabled';
     if ( $status eq "enabled" )
     {
 	$OUT = "LoadModule perl_module        modules/mod_perl.so";
Index: e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/20LoadModule80mod_ssl
diff -u e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/20LoadModule80mod_ssl:1.2 e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/20LoadModule80mod_ssl:1.3
--- e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/20LoadModule80mod_ssl:1.2	Tue Nov  9 15:36:38 2004
+++ e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/20LoadModule80mod_ssl	Mon Jul 18 14:52:00 2005
@@ -1,14 +1,8 @@
 {
-	use esmith::config;
-	use esmith::db;
-
-	my %conf;
-	tie %conf, 'esmith::config';
-
-	my $status = db_get_prop(\%conf, "modSSL", "status");
-
-	if (defined $status and $status eq "enabled")
-	{
-		$OUT = "LoadModule ssl_module        modules/mod_ssl.so"; 
-	}
+    # vim: ft=perl:
+    my $status = $modSSL{status} || 'disabled';
+    if ( $status eq "enabled" )
+    {
+	$OUT = "LoadModule ssl_module        modules/mod_ssl.so"; 
+    }
 }
Index: e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/35Listen80
diff -u e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/35Listen80:1.1.1.1 e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/35Listen80:1.2
--- e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/35Listen80:1.1.1.1	Tue Jan  7 10:00:49 2003
+++ e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/35Listen80	Mon Jul 18 14:52:00 2005
@@ -1,12 +1,11 @@
 {
     my $listen_default = "Listen 0.0.0.0:80";
 
-    my $mode = db_get($confref, "SystemMode") || "serveronly";
+    my $mode = $SystemMode || "serveronly";
 
     return $listen_default if ($mode eq "serveronly");
 
-    my $httpdAccess =
-	db_get_prop($confref, "httpd-e-smith", "access") || "private";
+    my $httpdAccess = ${'httpd-e-smith'}{access} || 'private';
 
     return $listen_default unless ($httpdAccess eq "private");
 
Index: e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/35ProxyPass
diff -u e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/35ProxyPass:1.3 e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/35ProxyPass:1.4
--- e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/35ProxyPass:1.3	Fri May 27 15:48:12 2005
+++ e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/35ProxyPass	Mon Jul 18 14:52:00 2005
@@ -40,6 +40,8 @@
 	{
 	    # Convert from comma separated list to space separated
 	    $valid =~ s/,/ /g;
+	    # Make sure that /32 ValidFrom specs don't cause Apache problems.
+	    $valid =~ s:/255.255.255.255::g;
 	    $OUT .= "    order deny,allow\n";
 	    $OUT .= "    deny from all\n";
 	    $OUT .= "    allow from $valid\n";
Index: e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/35SSL00Listen443
diff -u e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/35SSL00Listen443:1.1.1.1 e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/35SSL00Listen443:1.2
--- e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/35SSL00Listen443:1.1.1.1	Tue Jan  7 10:00:49 2003
+++ e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/35SSL00Listen443	Mon Jul 18 14:52:00 2005
@@ -1,12 +1,11 @@
 {
     my $listen_default = "Listen 0.0.0.0:443";
 
-    my $mode = db_get($confref, "SystemMode") || "serveronly";
+    my $mode = $SystemMode || "serveronly";
 
     return $listen_default if ($mode eq "serveronly");
 
-    my $httpdAccess =
-	db_get_prop($confref, "httpd-e-smith", "access") || "private";
+    my $httpdAccess = ${'httpd-e-smith'}{access} || 'private';
 
     return $listen_default unless ($httpdAccess eq "private");
 
Index: e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/35SSL10SetEnvIf
diff -u e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/35SSL10SetEnvIf:1.1 e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/35SSL10SetEnvIf:1.2
--- e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/35SSL10SetEnvIf:1.1	Fri Jan 24 17:51:59 2003
+++ e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/35SSL10SetEnvIf	Mon Jul 18 14:52:00 2005
@@ -1,5 +1 @@
-{
-    $OUT = <<SSL_END;
 SetEnvIf User-Agent ".*MSIE.*" nokeepalive ssl-unclean-shutdown downgrade-1.0 force-response-1.0
-SSL_END
-}
Index: e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/75AddTypes05.crl
diff -u e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/75AddTypes05.crl:1.1.1.1 e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/75AddTypes05.crl:1.2
--- e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/75AddTypes05.crl:1.1.1.1	Tue Jan  7 10:00:49 2003
+++ e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/75AddTypes05.crl	Mon Jul 18 14:52:00 2005
@@ -2,16 +2,9 @@
 #
 #   MIME-type for downloading CRLs
 #
-	use esmith::config;
-	use esmith::db;
-
-	my %conf;
-	tie %conf, 'esmith::config';
-	
-	my $status = db_get_prop(\%conf, "modSSL", "status");
-
-	if (defined $status and $status eq "enabled")
-	{
-		$OUT = "AddType application/x-pkcs7-crl    .crl\n";
-	}
+    my $status = $modSSL{status} || 'disabled';
+    if ( $status eq "enabled" )
+    {
+	$OUT = "AddType application/x-pkcs7-crl    .crl\n";
+    }
 }
Index: e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/75AddTypes05.crt
diff -u e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/75AddTypes05.crt:1.1.1.1 e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/75AddTypes05.crt:1.2
--- e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/75AddTypes05.crt:1.1.1.1	Tue Jan  7 10:00:49 2003
+++ e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/75AddTypes05.crt	Mon Jul 18 14:52:00 2005
@@ -2,16 +2,9 @@
 #
 #   MIME-type for downloading Certificates
 #
-	use esmith::config;
-	use esmith::db;
-
-	my %conf;
-	tie %conf, 'esmith::config';
-	
-	my $status = db_get_prop(\%conf, "modSSL", "status");
-	
-	if (defined $status and $status eq "enabled")
-	{
-		$OUT .= "AddType application/x-x509-ca-cert .crt\n";
-	}
+    my $status = $modSSL{status} || 'disabled';
+    if ( $status eq "enabled" )
+    {
+	$OUT .= "AddType application/x-x509-ca-cert .crt\n";
+    }
 }
Index: e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/85ServerResourcesAccess
diff -u e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/85ServerResourcesAccess:1.3 e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/85ServerResourcesAccess:1.4
--- e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/85ServerResourcesAccess:1.3	Thu May  6 17:11:13 2004
+++ e-smith-apache/root/etc/e-smith/templates/etc/httpd/conf/httpd.conf/85ServerResourcesAccess	Mon Jul 18 14:52:00 2005
@@ -4,10 +4,5 @@
     Options +Indexes
     order deny,allow
     deny from all
-{
-    $OUT .= "    allow from $localAccess";
-    # Add httpd-admin's ValidFrom list.
-    my @validfrom = split /,/, ${'httpd-admin'}{ValidFrom};
-    $OUT .= " @validfrom";
-}
+    allow from { "$localAccess $externalSSLAccess"; }
 </Directory>
